# ChestMNIST Configuration
# Chest X-ray Classification with 14 disease labels

project:
  name: "triage-learning-chest"
  description: "Triage System for Chest X-ray Classification"
  version: "0.1.0"

experiment:
  name: "chestmnist_efficientnet"
  tags: ["chestmnist", "efficientnet", "xray", "multi-label"]
  notes: "EfficientNet for multi-label chest disease classification"

paths:
  data_dir: "./data"
  output_dir: "./results/chestmnist"
  checkpoint_dir: "./experiments/chestmnist"
  log_dir: "./logs/chestmnist"

# ChestMNIST Dataset (14 binary labels for diseases)
dataset:
  name: "chestmnist"
  data_flag: "chestmnist"
  download: true
  size: 28
  num_classes: 14
  input_channels: 1              # Grayscale X-rays
  as_rgb: false                  # Convert to RGB for pretrained models
  class_names:
    - "Atelectasis"
    - "Cardiomegaly"
    - "Effusion"
    - "Infiltration"
    - "Mass"
    - "Nodule"
    - "Pneumonia"
    - "Pneumothorax"
    - "Consolidation"
    - "Edema"
    - "Emphysema"
    - "Fibrosis"
    - "Pleural Thickening"
    - "Hernia"

data_split:
  train_ratio: 0.8
  val_ratio: 0.1
  test_ratio: 0.1
  random_seed: 42

# Augmentation tailored for X-rays
augmentation:
  train:
    enable: true
    level: "standard"            # light, standard, aggressive
    # X-ray specific: subtle augmentation
    random_horizontal_flip: 0.3  # Conservative for medical images
    random_vertical_flip: 0.0    # No vertical flip for chest X-rays
    random_rotation: 10          # Subtle rotation
    elastic_deform: 0.1
    gaussian_blur: 0.1
    normalize:
      mean: [0.5]                # Grayscale mean
      std: [0.5]                 # Grayscale std
  val:
    enable: true
    normalize:
      mean: [0.5]
      std: [0.5]
  test:
    enable: true
    normalize:
      mean: [0.5]
      std: [0.5]

# Model architecture - EfficientNet better for chest X-rays
model:
  architecture: "efficientnet"
  variant: "b3"                  # b3 good balance for medical imaging
  pretrained: true
  num_classes: 14
  input_channels: 1
  dropout_rate: 0.3
  freeze_backbone: false         # Fine-tune entire network

# Training configuration
training:
  max_epochs: 100
  batch_size: 64                 # Larger batches for stability
  num_workers: 4
  learning_rate: 0.001
  weight_decay: 1e-4
  
  # Optimizer for medical imaging
  optimizer:
    name: "adamw"
    beta1: 0.9
    beta2: 0.999
    eps: 1e-8
  
  # Learning rate schedule
  scheduler:
    name: "cosine"
    T_max: 100
    eta_min: 1e-6
    warmup_epochs: 5
    warmup_type: "linear"
  
  # Loss function - weighted for multi-label
  loss:
    name: "weighted_binary_cross_entropy"
    class_weights: [1.5, 2.0, 1.5, 1.3, 1.8, 1.3, 2.5, 2.0, 1.4, 1.2, 1.1, 1.4, 1.1, 1.6]
    pos_weight: 2.0
  
  # Early stopping
  early_stopping:
    enable: true
    monitor_metric: "val_loss"
    mode: "min"
    patience: 15
    min_delta: 1e-4
    restore_best_weights: true
  
  # Gradient handling
  gradient:
    max_norm: 1.0                # Gradient clipping
    accumulation_steps: 1

# Uncertainty estimation
uncertainty:
  enable: true
  methods:
    - "mc_dropout"
    - "temperature_scaling"
  mc_dropout:
    num_samples: 20
    dropout_rate: 0.3
  temperature_scaling:
    enable: true
    method: "lbfgs"
    max_iters: 100

# Triage configuration
triage:
  enable: true
  strategies:
    - "threshold"
    - "budget_constrained"
    - "cost_sensitive"
  
  threshold_strategy:
    percentile: 75               # Defer 25% most uncertain
  
  budget_strategy:
    budget_rate: 0.2             # Defer 20% of samples
  
  cost_sensitive:
    ai_error_cost: 100           # High cost for AI errors in medical
    human_review_cost: 2
  
  # Human expert configuration
  human_expert:
    accuracy: 0.92               # High for radiologists
    class_specific_accuracy:
      - 0.95                     # High accuracy on common diseases
      - 0.90
      - 0.93
      - 0.88
      - 0.92
      - 0.89
      - 0.94
      - 0.91
      - 0.90
      - 0.93
      - 0.87
      - 0.90
      - 0.86
      - 0.91
  
  # Critical disease classes
  critical_classes: [1, 2, 7]   # Cardiomegaly, Effusion, Pneumothorax

# Evaluation configuration
evaluation:
  metrics:
    - "accuracy"
    - "balanced_accuracy"
    - "auc_roc"
    - "auc_pr"
    - "f1_score"
    - "sensitivity"
    - "specificity"
  
  triage_metrics:
    - "automation_efficiency"
    - "workload_reduction"
    - "safety_metrics"
    - "cost_benefit_analysis"

# Device configuration
device:
  type: "cuda"                   # cuda or cpu
  distributed: false
  device_id: 0

# Logging and checkpointing
logging:
  level: "INFO"
  format: "%(asctime)s - %(name)s - %(levelname)s - %(message)s"
  tensorboard: true
  wandb: false

checkpoint:
  save_strategy: "best"          # best or last or all
  monitor_metric: "val_accuracy"
  mode: "max"
  save_top_k: 3
  save_every_n_epochs: 5

# Reproducibility
seed: 42
deterministic: true

# Hyperparameter presets
presets:
  quick:
    max_epochs: 10
    batch_size: 128
    learning_rate: 0.001
  
  standard:
    max_epochs: 100
    batch_size: 64
    learning_rate: 0.001
  
  extensive:
    max_epochs: 200
    batch_size: 32
    learning_rate: 0.0005
    num_workers: 8
